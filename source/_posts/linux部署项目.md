---
title: linux下部署项目
date: 2017-03-05 13:21:34
update: 2017-03-05 13:21:34
categories: Linux
tags: [linux, 部署, tomcat]
---
### 1 部署项目
<!-- more -->
注意：先安装JDK,然后再部署项目

#### 1、创建普通用户

一般生产环境是不会使用root用户来发布tomcat等应用的。
```
# 创建linux服务器的普通用户，用户名为ucenter，默认权限目录为home下的ucenter目录
useradd ucenter
# 进入根目录的home目录中
cd home
# 查看当前用户所处的目录
pwd
# ll会列出该文件下的所有文件信息，包括隐藏的文件，而ls -l只列出显式文件
ll
# 切换用户到ucenter
su - ucenter
# 查看当前用户所处的目录
pwd
/home/ucenter
# 创建用户，用户名为ucenter访问权限为根目录下ucenter目录
useradd ucenter -d /ucenter
# 设置ucenter用户的密码为:ucenter
passwd ucenter
# 为ucenter用户创建ucenter目录
mkdir /ucenter
# 把ucenter目录及其下所有的目录的授权给ucenter用户和其所在的组
chown ucenter:ucenter /ucenter/ -R
```
#### 2、安装tomcat
```
cd /ucenter/
mkdir web
cd web/
mkdir taotao-manage
cd taotao-manage/
# 上传tomcat
rz
# 解压到当前目录
tar -xvf apache-tomcat-7.0.57.tar.gz
# 重命名
mv apache-tomcat-7.0.57 taotao-manage-tomcat
cd taotao-manage-tomcat
cd webapps/
# 删除当前目录下所有的文件和文件夹
rm -rf *
# 创建ROOT目录
mkdir ROOT
# 上传打好的war包，taotao-manage.war
rz
# 使用jdk提供的jar命令，解压war包
jar -xvf taotao-manage.war
# 解压成功删除taotao-manage.war
rm  -rf taotao-manage.war
```
问题
1. tomcat8080端口号没有开放,需要开放8080端口号
防火墙配置文件中新增
-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT
```
[root@VM_0_11_redhat bin]# vim /etc/sysconfig/iptables
[root@VM_0_11_redhat bin]# E45: 'readonly' option is set (add ! to override)
```
该错误为当前用户没有权限对文件作修改

有三种可能：

1 . 该错误为当前用户没有权限对文件作修改,你有权限修改文件吗？如果是root权限，可以:wq! 强行保存退出；

2 . 该文件没有正确保存退出，正在打开状态，请别人关闭后再保存；

3 . 若该文件所有人都关闭了，提示有的人没有关闭，则删除该文件的临时文件则可以正常打开、修改、保存；

有文件未关闭的显示：

修改后的防火墙配置文件为
```
*filter
:INPUT ACCEPT [78:5009]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [79:8885]
COMMIT
# Completed on Tue Feb 13 12:43:16 2018
# Generated by iptables-save v1.4.21 on Tue Feb 13 12:43:16 2018
*mangle
:PREROUTING ACCEPT [6097:393440]
:INPUT ACCEPT [6097:393440]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [5588:622584]
:POSTROUTING ACCEPT [5588:622584] 
-A POSTROUTING -p tcp -j TCPOPTSTRIP --strip-options 8
-A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT
COMMIT   
# Completed on Tue Feb 13 12:43:16 2018
# Generated by iptables-save v1.4.21 on Tue Feb 13 12:43:16 2018
*nat         
:PREROUTING ACCEPT [1130:42445]
:INPUT ACCEPT [1130:42445]
:OUTPUT ACCEPT [906:61147] 
:POSTROUTING ACCEPT [0:0] 
-A POSTROUTING -j MASQUERADE
COMMIT 
```
**开放端口号后，可能要重启防火墙**

CentOS中防火墙程序主要是firewall和iptables
CentOS7下使用iptables会报错
```
[root@VM_0_11_redhat home]# systemctlrestart iptables.service
-bash: systemctlrestart: command not found
```
systemctlrestart iptables.service # 最后重启防火墙使配置生效
systemctlenable iptables.service # 设置防火墙开机启动

在CentOS7下使用firewall
查看防火墙状态
```
[root@VM_0_11_redhat home]# firewall-cmd --state
not running
```
关闭防火墙
```
[root@VM_0_11_redhat home]# systemctl stop firewalld.service
```
开启防火墙

会遇到Failed to start firewalld.service: Unit is masked.的错误

```
[root@VM_0_11_redhat home]# systemctl start firewalld.service
[root@VM_0_11_redhat ~]# systemctl start firewalld
Failed to start firewalld.service: Unit is masked.
[root@VM_0_11_redhat ~]# systemctl unmask firewalld
Removed symlink /etc/systemd/system/firewalld.service.
```


禁止开机启动启动防火墙
```
[root@VM_0_11_redhat home]# systemctl disable firewalld.service
```

检查是否已安装iptables
```
[root@VM_0_11_redhat home]# service iptables status
```
安装iptables
```
[root@VM_0_11_redhat home]# yum install -y iptables
```

升级iptables（安装的最新版本则不需要）
```
[root@VM_0_11_redhat home]# yum update iptables
```

安装iptables-services

```
[root@VM_0_11_redhat home]# yum install iptables-services
```
参考文章：https://www.cnblogs.com/anne32184/p/5961806.html

#### 3、修改项目配置文件
```
# 修改配置文件
cd /ucenter/web/taotao-manage/taotao-manage-tomcat/WEB-INF/classes
vim env.properties
# 修改为
REPOSITORY_PATH=/ucenter/web/taotao-upload
IMAGE_BASE_URL=http://image.taotao.com
TAOTAO_WEB_UTL=http://www.taotao.com
# 保存退出
:wq
# 创建taotao-upload目录
mkdir /ucenter/web/taotao-upload
# 修改jdbc.properties
# 修改rabbitmq.properties
rabbitmq.host=服务器ip地址
rabbitmq.port=5672
rabbitmq.username=taotao
rabbitmq.password=taotao
rabbitmq.vhost=/taotao
# 修改redis.properties
redis.maxTotal=100
redis.node1.host=服务器ip地址
redis.node1.port=6379
# 保存退出
```
#### 4、启动tomcat
```
cd /ucenter/web/taotao-manage/taotao-manage-tomcat/bin
# 查看8080端口是否开放
/etc/init.d/iptables status
# dtp后面为开放的端口号，没有8080端口号，需要添加8080端口
/sbin/iptables -I INPUT -p tcp --dport 8080 -j ACCEPT
/etc/rc.d/init.d/iptables save
# 启动tomcat
./startup.sh
# 浏览器访问地址：[服务器ip:8080/rest/page/index]成功访问
```
#### 5、解决浏览器无法访问线上项目问题
```
# 查看所有的tomcat进程
ps -ef | grep tomcat
# 结束多个进程
kill -9 18007 23419
# 提示不允许的操作，说明没有权限，需要用root用户进行kill
# 结束全部tomcat进程后，重新启动tomcat
cd /ucenter/web/taotao-manage/taotao-manage-tomcat/bin
# 启动taotao-manage-tomcat并查看tomcat日志，&& 代表逻辑执行，如果前面的命令执行成功就执行后面的命令
./statup.sh && tail -f ../logs/catalina.out
# 浏览器访问地址：[服务器ip:8080/rest/page/index]成功访问
```
#### 6、本地通过域名访问线上项目
##### 6.1修改本地SwitchHosts映射
本地使用SwitchHosts映射，nginx反向代理，访问本地项目，要想访问线上的项目，需要修改SwitchHosts映射和nginx反向代理配置
```
# SwitchHosts映射修改为
# 淘淘生产环境
安装nginx服务器的ip地址 manage.taotao.com
```
##### 6.2修改线上nginx代理配置
```
# 进入安装ngin的服务器，切换到普通用户
su ucenter
cd soft/nginx/conf
vim nginx.conf
# 先做bak
mv nginx.conf nginx.conf.bak
# 上传本地的nginx.conf配置文件
rz
# 打开nignx.conf(这个文件应该是uft-8进行编码的，否则上传到服务器会出现中文乱码)
vim nginx.conf
# 修改manage.taotao.com的代理如下
server {
	listen       80;
	server_name  manage.taotao.com;
	#charset koi8-r;
	#access_log  logs/host.access.log  main;
	proxy_set_header X-Forwarded-Host $host;
	proxy_set_header X-Forwarded-Server $host;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	location / {
		proxy_pass http://部署taotao-manage项目的tomcat所在的服务器的ip地址:8080;
		proxy_connect_timeout 600;
		proxy_read_timeout 600;
	}
}
# 保存退出:wq
cd sbin/
# 重启nginx
./nginx -s reload
# 浏览器访问地址：[manage.taotao.com/rest/page/index]成功访问
```
### 2 其他项目部署问题

```
# taotao-web项目，evn.properties
TAOTAO_MANAGE_URL=http://manage.taotao.com
TAOTAO_ORDER_URL=http://order.taotao.com
TAOTAO_SSO_URL=http://sso.taotao.com
TAOTAO_CART_URL=http://cart.taotao.com
TAOTAO_ORDER_URL=http://order.taotao.com
TAOTAO_CART_UTL=http://cart.taotao.com
SSO_TAOTAO_URL=http://sso.taotao.com
INDEX_AD1_URL=/rest/content?categoryId=16&page=1&rows=6
INDEX_AD2_URL=/rest/content?categoryId=18&page=1&rows=1
# 修改rabbitmq.properties
rabbitmq.host=安装rabbitmq服务器IP
rabbitmq.port=5672
rabbitmq.username=taotao
rabbitmq.password=taotao
rabbitmq.vhost=/taotao
# 修改redis.properties
redis.maxTotal=100
redis.node1.host=安装redis服务器的IP
redis.node1.port=6379
```
taotao-web前台项目需要访问后台taotao-manage项目
进入部署taotao-web项目的tomcat所在的服务器，进行ping
```
ping taotao.manage.com
# ping不通，无法访问后台项目，这里就需要参考evn.properties配置文件修改hosts文件
vim /etc/hosts
安装nginx服务器的ip地址 manage.taotao.com
安装nginx服务器的ip地址 order.taotao.com
安装nginx服务器的ip地址 sso.taotao.com
安装nginx服务器的ip地址 cart.taotao.com
# 保存退出
```
### 3 配置访问静态资源
```
cd cd soft/nginx/conf
vim nginx.conf
# 查找image字符串
/image
# 修改nginx代理访问静态资源
# 首先创建静态资源访问目录
cd /ucenter
# 上传静态资源,taotao-upload.tar.gz
rz
# 解压tar包
tar -xvf taotao-upload
rm -rf taotao-upload.tar.gz
# 查看静态资源
cd taotao-upload
cd cd soft/nginx/conf
vim nginx.conf
# 修改访问静态资源路径
server {
	listen       80;
	server_name  image.taotao.com;
	#charset koi8-r;
	#access_log  logs/host.access.log  main;
	proxy_set_header X-Forwarded-Host $host;
	proxy_set_header X-Forwarded-Server $host;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	location / {
		root  /ucenter/taotao-upload;
	} 
}
# 保存退出
cd ../sbin/
# 重启nginx
./nginx -s reload
```
### 4 solr相关配置
```
# taotao-search-tomcat中项目配置文件evn.properties
TAOTAO_MANAGE_URL=http://manage.taotao.com
# 也要在安装tomcat[taotao-search-tomcat]所在的服务其中配置hosts
vim /etc/hosts
安装nginx服务器的ip地址 manage.taotao.com
# taotao-search-tomcat中项目配置文件solr.properties
solr.url=http://solr.taotao.com/taotao
solr.maxRetries=1
solr.connectionTimeout=500
# 需要配置hosts，这里仍然指向nginx所在的服务器
安装nginx服务器的ip地址 solr.taotao.com
# 需要注意的是域名全部要指向ngin所在的服务器
# 最后的tomcat[taotao-search-tomcat]所在的服务其中配置hosts配置为
安装nginx服务器的ip地址 manage.taotao.com
安装nginx服务器的ip地址 solr.taotao.com
```

### 5 遇到的问题

```
<Server port="29051" shutdown="SHUTDOWN">

<Connector port="19051" protocol="HTTP/1.1" maxThreads="150" connectionTimeout="20000" redirectPort="8443" URIEncoding="UTF-8"/>
URIEncoding="UTF-8"可解决get请求中文乱码
			   
<Connector port="39051" protocol="AJP/1.3" redirectPort="8443" />
```
